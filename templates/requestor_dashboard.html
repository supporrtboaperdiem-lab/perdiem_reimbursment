<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Requestor Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: "Inter", system-ui, sans-serif; margin:0; padding:0; min-height:100vh; background:#6a0f1a; }
        header { background: rgba(106, 15, 26, 0.85); backdrop-filter: blur(8px); color:#fff; padding:18px 28px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
        header h1 { font-size:22px; margin:0; font-weight:700; }
        .logout { color:#fff; text-decoration:none; font-weight:600; }
        .logout:hover { text-decoration:underline; color:#ffdede; }
        .container { padding:12px 28px; max-width:1200px; margin:auto; }
        .card { background: rgba(255,255,255,0.95); border-radius:20px; padding:28px 30px; margin-bottom:20px; box-shadow:0 15px 35px rgba(0,0,0,0.25); transition: all 0.3s ease; }
        .card h2 { margin-top:0; margin-bottom:16px; color:#6a0f1a; font-size:18px; font-weight:700; }
        .form-row { display:grid; grid-template-columns:repeat(2,1fr); gap:20px; margin-bottom:20px; }
        label { display:block; font-weight:600; margin-bottom:6px; font-size:14px; color:#333; }
        input[type="text"], input[type="date"], select, input[type="file"] { padding:10px 14px; border-radius:10px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; transition:border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus { outline:none; border-color:#c73645; box-shadow:0 0 0 3px rgba(199,54,69,0.18); }
        .input-from { width:100%; height:44px; }
        .input-contra { width:85%; height:40px; }
        .input-district { width:50%; height:44px; background-color:#fff; cursor:pointer; }
        .input-birr { width:30%; height:36px; padding:0 10px; }
        .input-sendto { width:100%; height:44px; }
        .input-reason { width:100%; height:60px; }
        .btn { background: linear-gradient(135deg, #6a0f1a, #8b1d2c); color:#fff; border:none; padding:12px 22px; border-radius:12px; font-size:15px; font-weight:600; cursor:pointer; }
        .btn:hover { box-shadow:0 8px 18px rgba(0,0,0,0.25); }
        .btn-pdf { background: linear-gradient(135deg, #1e8e3e, #0b5d2a); }
    
        .btn-review {background: linear-gradient(135deg, #2c7be5, #1a4fa3); }
        table { width:100%; border-collapse:collapse; font-size:14px; border-radius:12px; overflow:hidden; }
        table th, table td { padding:14px 6px; border-bottom:1px solid #e0e0e0; text-align:left; }
        table th { background:#ffffff; font-weight:700; }
        .status { font-weight:700; }
        .status.SUBMITTED { color: #cc8400; }
        .status.APPROVED_BY_REQUESTOR_ADMIN { color: #8c32a7; }
        .status.APPROVED_BY_INTERMEDIATE_APPROVER { color: #22afd2; }
        .status.APPROVED_BY_FINAL_APPROVER { color: #28cf6e; }
        .status.APPROVED_BY_MANAGERIAL_APPROVER { color: #28cf6e; }
        .status.PROCESSED_BY_FINANCE { color: #1e8e3e; }

        .status.DECLINED_BY_REQUESTOR_ADMIN { color: #ff1414; } 
        .status.DECLINED_BY_INTERMEDIATE_APPROVER { color: #ff1414; } 
        .status.DECLINED_BY_MANAGERIAL_APPROVER { color: #ff1414; } 
        .status.DECLINED_BY_FINAL_APPROVER { color: #ff1414; } 	
        .status.DECLINED_BY_FINANCE { color: #ff1414; } 


/* Fullscreen transparent overlay */
#processingOverlay {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    backdrop-filter: blur(6px);
    background: rgba(0,0,0,0.2); /* slightly dark transparent */
    z-index:10000;
}

/* Container */
.ai-container {
    position: relative;
    width: 250px;
    height: 250px;
    display:flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Rotating circle wrapper */
.ai-circle-wrapper {
    position: relative;
    width: 150px;
    height: 150px;
}

/* Circle elements */
.ai-circle {
    position: absolute;
    top:50%; left:50%;
    width: 12px; height: 12px;
    margin:-6px 0 0 -6px;
    border-radius:50%;
    background: linear-gradient(45deg, #1a4fa3, #28cf6e);
    animation: orbit 2.5s linear infinite;
}

.ai-circle:nth-child(1){ animation-delay:0s; transform: rotate(0deg) translateX(70px) rotate(0deg);}
.ai-circle:nth-child(2){ animation-delay:0.4s; transform: rotate(90deg) translateX(70px) rotate(-90deg);}
.ai-circle:nth-child(3){ animation-delay:0.8s; transform: rotate(180deg) translateX(70px) rotate(-180deg);}
.ai-circle:nth-child(4){ animation-delay:1.2s; transform: rotate(270deg) translateX(70px) rotate(-270deg);}

/* Orbit animation */
@keyframes orbit {
    0% { transform: rotate(0deg) translateX(70px) rotate(0deg);}
    100% { transform: rotate(360deg) translateX(70px) rotate(-360deg);}
}

/* AI Text */
.ai-text {
    margin-top: 20px;
    font-family: "Inter", sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: #1a4fa3;
    text-shadow: 0 0 12px #28cf6e, 0 0 20px #1a4fa3;}
        /* Fullscreen glass overlay */
#processingOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.overlay-background {
    width: 100%;
    height: 100%;
    background: rgba(26, 79, 163, 0.65);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Loader container */
.loader-container {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    border-radius: 24px;
    padding: 40px 60px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.35);
    animation: popIn 0.25s ease;
}

/* Loader spinner */
.spinner {
    display: inline-block;
    position: relative;
    width: 60px;
    height: 60px;
    margin-bottom: 20px;
}

.spinner div {
    transform-origin: 30px 30px;
    animation: spinnerFade 1.2s linear infinite;
    position: absolute;
    width: 6px;
    height: 18px;
    border-radius: 3px;
    background: linear-gradient(180deg, #1a4fa3, #28cf6e);
    top: 6px;
    left: 27px;
}

.spinner div:nth-child(1) { transform: rotate(0deg); animation-delay: -1.1s; }
.spinner div:nth-child(2) { transform: rotate(90deg); animation-delay: -1.0s; }
.spinner div:nth-child(3) { transform: rotate(180deg); animation-delay: -0.9s; }
.spinner div:nth-child(4) { transform: rotate(270deg); animation-delay: -0.8s; }

@keyframes spinnerFade {
    0%, 39%, 100% { opacity: 0.25; }
    40% { opacity: 1; }
}

/* Text under spinner */
.overlay-text {
    font-family: "Inter", sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #fff;
}

/* Pop-in animation */
@keyframes popIn {
    from { transform: scale(0.85); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

        /* OCR Overlay */

        #processingOverlay {
    display: none; /* already done */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(26, 79, 163, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

#ocrOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26, 79, 163, 0.75); /* semi-transparent corporate blue */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.ocr-container {
    text-align: center;
    background: #ffffff;
    padding: 40px 60px;
    border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.35);
}

.ocr-text {
    font-family: "Inter", sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #1a4fa3; /* deep corporate blue */
    margin-top: 20px;
}

/* Bars Animation */
.ocr-animation {
    display: flex;
    justify-content: center;
    gap: 6px;
    height: 20px;
    margin-top: 10px;
}

.ocr-bar {
    width: 6px;
    background: linear-gradient(180deg, #1a4fa3 0%, #28cf6e 100%);
    border-radius: 3px;
    animation: bounce 1s infinite ease-in-out;
}

.ocr-bar:nth-child(1) { animation-delay: 0s; }
.ocr-bar:nth-child(2) { animation-delay: 0.15s; }
.ocr-bar:nth-child(3) { animation-delay: 0.3s; }
.ocr-bar:nth-child(4) { animation-delay: 0.45s; }
.ocr-bar:nth-child(5) { animation-delay: 0.6s; }

@keyframes bounce {
    0%, 100% { transform: scaleY(0.3); }
    50% { transform: scaleY(1); }
}


        .progress {
  height: 6px;
  background: #eee;
  border-radius: 6px;
  overflow: hidden;
  margin-top: 8px;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(135deg,#6a0f1a,#c73645);
  transition: width .2s;
}
.thumb {
  max-width: 90px;
  max-height: 90px;
  border-radius: 6px;
  margin-right: 6px;
}

.money {
        font-family: "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
        font-weight: 600;
        font-size: 1rem;
        color: #1e3a8a; /* Deep blue money tone */
    }

.delete-btn {
  background:#c73645;
  color:#fff;
  border:none;
  padding:4px 8px;
  border-radius:6px;
  cursor:pointer;
}

.flash-container {
        margin-bottom: 20px;
        text-align: center;
    }

    .flash {
        padding: 10px 20px;
        margin: 5px auto;
        border-radius: 8px;
        font-weight: bold;
        width: fit-content;
        min-width: 200px;
        color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        animation: fadein 0.5s ease;
    }

    .flash-success { background-color: #4caf50; }   /* green */
    .flash-error   { background-color: #f44336; }   /* red */
    .flash-danger  { background-color: #f44336; }   /* red (alternative) */
    .flash-warning { background-color: #ff9800; }   /* orange */
    .flash-info    { background-color: #2196f3; }   /* blue */

    @keyframes fadein {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

/* PROFILE DROPDOWN */
.profile-wrapper {
    position: relative;
}

.profile-img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    cursor: pointer;
    object-fit: cover;
    border: 2px solid #ffffff40;
    transition: 0.3s ease;
}

.profile-img:hover {
    transform: scale(1.08);
    box-shadow: 0 0 15px rgba(255,255,255,0.4);
}

.profile-dropdown {
    position: absolute;
    right: 0;
    top: 60px;
    width: 220px;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    display: none;
    animation: fadeDropdown 0.2s ease;
    overflow: hidden;
    z-index: 9999;
}

.profile-dropdown a {
    display: block;
    padding: 12px 16px;
    text-decoration: none;
    font-size: 14px;
    color: #333;
    font-weight: 500;
    transition: 0.2s;
}

.profile-dropdown a:hover {
    background: #f4f4f4;
}

.profile-info {
    padding: 14px 16px;
    background: #f9f9f9;
}

.logout-item {
    color: #c73645;
    font-weight: 600;
}

@keyframes fadeDropdown {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
}
.profile-wrapper {
    display: inline-block; /* keep the image inline */
    cursor: pointer;       /* changes cursor on hover */
}

.profile-img {
    width: 80px;
    height: 50px;
    border-radius: 8px;         /* optional: rounded corners */
    object-fit: cover;          /* prevent distortion */
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* smooth effect */
}

.profile-img:hover {
    transform: scale(1.2);     /* zoom in 20% */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* subtle shadow */
}


 a.logout-item,
    a[href$="change_password"] {  /* selects your Change Password link */
        color: #F5F5DC;           /* Cream / Off-White */
        text-decoration: none;    /* Remove underline */
        transition: color 0.3s, transform 0.3s; /* smooth hover effects */
    }

    a.logout-item:hover,
    a[href$="change_password"]:hover {
        color: #FFF8E1;           /* Slightly brighter cream on hover */
        transform: scale(1.1);    /* Zoom slightly on hover */
    }

    </style>
</head>
<body>

<header>
    <h1>Requestor Dashboard</h1>
    <div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
    <div class="profile-wrapper" style="position: relative;">
        <img src="{{ url_for('static', filename='images/profile_1.png') }}" 
             style="width: 80px; height: 50px; cursor:pointer;" 
             class="profile-img" id="profileToggle">
    
             <div class="profile-dropdown" id="profileDropdown" style="display:none; position:absolute; right:0; top:60px; width:250px; padding:20px; border-radius:16px; background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border:1px solid rgba(255,255,255,0.3); backdrop-filter: blur(22px) saturate(180%); -webkit-backdrop-filter: blur(22px) saturate(180%); box-shadow: 0 8px 32px rgba(0,0,0,0.25), inset 0 0 20px rgba(255,255,255,0.2); transition: all 0.3s ease; z-index:1000;">
            <div class="logout" style="margin-bottom:10px;color:#d9d940;">
                <strong>{{ current_user.username }}</strong><br>
                <small>{{ current_user.role }}</small>
            </div>
            <hr style="margin:10px 0;">
    
            <!-- Change Password Link -->
            <a href="javascript:void(0);" id="showChangePassword" 
               style="display:block; margin-bottom:10px; color:#FFC857; text-decoration:none;">Change Password</a>
    
            <!-- Inline Change Password Form -->
            <div id="changePasswordForm" style="display:none; margin-bottom:10px;">
                <form method="POST" action="{{ url_for('auth.change_password') }}">
                    <div style="margin-bottom:8px;">
                        <input type="password" name="current_password" placeholder="Current Password" required
                               style="width:85%; padding:8px; border-radius:8px; border:1px solid #ccc;">
                    </div>
                    <div style="margin-bottom:8px;">
                        <input type="password" name="new_password" placeholder="New Password" required
                               style="width:85%; padding:8px; border-radius:8px; border:1px solid #ccc;">
                    </div>
                    <div style="margin-bottom:8px;">
                        <input type="password" name="confirm_password" placeholder="Confirm Password" required
                               style="width:85%; padding:8px; border-radius:8px; border:1px solid #ccc;">
                    </div>
                    <button type="submit" class="btn" style="width:85%; background:#6a0f1a; color:#fff; border:none; padding:8px; border-radius:8px;">Update Password</button>
                </form>
            </div>
    
            <!-- Logout Link -->
            <a class="logout" href="{{ url_for('auth.logout') }}" 
               style="display:block; color:#FFC857; text-decoration:none;">Logout</a>
        </div>
    </div>

</header>

<div class="container">
    

  

    <!-- Form 1 Card -->
    <div class="card" id="form1Card">
        
        <form id="form1">
            <h2>Submit Request</h2>

            <div class="form-row">
                <div>
                    <label>From <span style="color:red;">*</span></label>
                    <input type="text" name="From" class="input-from" placeholder="Enter From" required>
                </div>
                <div>
                    <label>Contra <span style="color:red;">*</span></label>
                    <input type="text" name="Contra" class="input-contra" placeholder="Enter Contra code" required>
                    <input type="text" name="Contra_name" class="input-contra" placeholder="Enter Contra Name" required>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>District  <span style="color:red;">*</span></label>
                    <select name="District" class="input-district" required>
                        <option value="">Select District</option>
                        <option>ADAMA</option>
                        <option>BAHIR DAR</option>
                        <option>CENTRAL ADDIS</option>
                        <option>DESSIE</option>
                        <option>DIRE DAWA</option>
                        <option>EAST ADDIS</option>
                        <option>HAWASSA</option>
                        <option>JIMMA</option>
                        <option>MEKELLE</option>
                        <option>WEST ADDIS</option>
                    </select>
                </div>
                <div>
                    <label>Birr</label>
                    <input type="text" name="Birr" class="input-birr" placeholder="0.00" oninput="formatBirr(this)">
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Send To  <span style="color:red;">*</span></label>
                    <input type="text" name="Send_To" class="input-sendto" placeholder="Enter Send To" required>
                </div>
                <div>
                    <label>Reason For Claim  <span style="color:red;">*</span></label>
                    <input type="text" name="Reason_For_Claim" class="input-reason" placeholder="Enter The Reason for Your Claim" required>
                </div>
            </div>

            <button class="btn" type="button" id="proceedBtn" data-request-id="{{ requests.id }}">
                PROCEED
            </button>
            
            
        </form>
    </div>

    <!-- Form 2 Card -->
    <div class="card" id="form2Card" style="display:none;">
        <h2>Upload Form 2</h2>

        <div class="decision">
            <label>
                <input type="radio" name="form2Option" value="self" checked onclick="showForm2Option('self')">
                Self Upload(<i>Form2 + Receipts</i>)
            </label>
            <label>
                <input type="radio" name="form2Option" value="system" onclick="showForm2Option('system')">
                System Generated(<i>Receipts only</i>)
            </label>
        </div>

        <!-- Self Upload Form -->
        <form method="POST" enctype="multipart/form-data" id="selfUploadCard">
            <div class="form-row">
                <div>
                    <label>Form 2 <span style="color:red;">*</span></label>
                    <input type="file" name="form2_file" accept="application/pdf" >
                    <div class="progress" style="display:none">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <label>Air Ticket</label>
                    <input type="file" name="receipt_air_ticket" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png"  multiple>
                    <div class="progress" style="display:none">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <label>Food & Beverage</label>
                    <input type="file" name="receipt_food" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                    <div class="progress" style="display:none">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <label>Bedroom</label>
                    <input type="file" name="receipt_bedroom"accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                    <div class="progress" style="display:none">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <label>Fuel & Transportation</label>
                    <input type="file" name="receipt_fuel" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                    <div class="progress" style="display:none">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <label>Others</label>
                    <input type="file" name="receipt_others" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                    <div class="progress" style="display:none">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
            <button class="btn" type="submit" >Submit Self Upload</button>
            <input type="hidden" name="submit_mode" value="self">

            <input type="hidden" name="From" >
            <input type="hidden" name="Contra">
            <input type="hidden" name="Contra_name">
            <input type="hidden" name="District">
            <input type="hidden" name="Birr">
            <input type="hidden" name="Send_To">
            <input type="hidden" name="Reason_For_Claim">
            


        </form>

        <!-- System Generated Form -->
        <form method="POST" enctype="multipart/form-data" id="systemGeneratedCard" style="display:none;">
            <!-- Step 1 -->
            <div id="systemStep1">
                <div class="form-row">
                    <div>
                        <label>Travel Begin <span style="color:red;">*</span></label>
                        <input type="date" name="travel_begin" required>
                        <select name="travel_begin_day_type" required>
                            <option value="full">Full Day</option>
                            <option value="half">Half Day</option>
                        </select>
                    </div>
                    <div>
                        <label>Travel End <span style="color:red;">*</span></label>
                        <input type="date" name="travel_end" required>
                        <select name="travel_end_day_type" required>
                            <option value="full">Full Day</option>
                            <option value="half">Half Day</option>
                        </select>
                    </div>
                    <div>
                        <label>Advance Taken  <span style="color:red;">*</span></label>
                        <input type="text" name="advance_taken" class="input-birr" required>
                    </div>
                    <div>
                        <label>Employee Name  <span style="color:red;">*</span></label>
                        <input type="text" name="employee_name" class="input-from" required>
                    </div>
                    <div>
                        <label>Employee Grade  <span style="color:red;">*</span></label>
                        <input type="text" name="employee_grade" required>
                    </div>
                    <div>
                        <label>Job Title  <span style="color:red;">*</span></label>
                        <input type="text" name="employee_position" class="input-from" required>
                    </div>
                    <div>
                        <label>Employee Account No  <span style="color:red;">*</span></label>
                        <input type="text" name="employee_account" required>
                    </div>
                    <div>
                        <label>Employee Department/Branch  <span style="color:red;">*</span></label>
                        <input type="text" name="employee_office" class="input-from" required>
                    </div>
                </div>

                <button class="btn" type="button" onclick="goToSystemStep2(event)">
                    Proceed
                </button>
            </div>

            <!-- Step 2 -->
            <div id="systemStep2" style="display:none;">
                <div class="form-row">
                    <div>
                        <label>Air Ticket</label>
                        <input type="file" name="sys_receipt_air_ticket" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png,application/pdf" multiple>
                        <div class="progress" style="display:none">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    <div>
                        <label>Food & Beverage</label>
                        <input type="file" name="sys_receipt_food" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                        <div class="progress" style="display:none">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    <div>
                        <label>Bedroom</label>
                        <input type="file" name="sys_receipt_bedroom" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                        <div class="progress" style="display:none">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    <div>
                        <label>Fuel & Transportation</label>
                        <input type="file" name="sys_receipt_fuel" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                        <div class="progress" style="display:none">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    <div>
                        <label>Others</label>
                        <input type="file" name="sys_receipt_others" accept="image/webp,image/heic,image/heif,image/jpg,image/jpeg,image/png" multiple>
                        <div class="progress" style="display:none">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                </div>
                <button class="btn" type="submit" >Submit System Generated</button>
                <input type="hidden" name="submit_mode" value="system">

                <input type="hidden" name="From" >
                <input type="hidden" name="Contra">
                <input type="hidden" name="Contra_name">
                <input type="hidden" name="District">
                <input type="hidden" name="Birr">
                <input type="hidden" name="Send_To">
                <input type="hidden" name="Reason_For_Claim">

                <input type="hidden" name="travel_begin">
                <input type="hidden" name="travel_end">
                <input type="hidden" name="travel_begin_day_type">
                <input type="hidden" name="travel_end_day_type">

                <input type="hidden" name="advance_taken">
                <input type="hidden" name="employee_name">
                <input type="hidden" name="employee_grade">
                <input type="hidden" name="employee_position">
                <input type="hidden" name="employee_account">
                <input type="hidden" name="employee_office">



            </div>
            
            
        </form>
    </div>

    <!-- Existing Per Diem Requests -->
    <div class="card">
        <h2>My Per Diem Requests</h2>
    
        {% if requests %}
        <table>
            <thead>
                <tr>
                    <th>Prediem ID</th>
                    <th>Date of Request</th>
                    <th>Aquired</th>
                    <th>Reimbursement Form</th>
                    <th>Perdiem Form</th>
                    <th>Status</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody>
                {% for r in requests %}
                <tr>
                    <td>{{ r.perdiem_code }}</td>
                    <td>{{ r.created_at.strftime('%Y-%m-%d') }}</td>
                    <td><b class="money"> {{ "{:,.2f}".format(r.birr_amount) }}</b></td>

                    <!-- Reimbursement PDF </-->
                    
                    <td>
                        <a href="{{ url_for('view_reimburs.view_reimburs_db_pdf', request_id=r.id) }}" class="btn btn-pdf" target="_blank">View PDF</a>
                        </td>

                    <!-- Perdiem PDF </-->
                    <td>
                        <a href="{{ url_for('view_perdi.view_perdi_db_pdf', request_id=r.id) }}" class="btn btn-pdf" target="_blank">View PDF</a>
            
                    </td>
                    <td class="status {{ r.status }}" 
                        style="font-size: 12px; max-width: 80px; word-wrap: break-word; white-space: normal;">
                        {{ r.status }}
                    </td>

                     <!-- FINAL/Managerial Approval </-->

                    <td>
                        
                            <a href="{{ url_for('adminreview.comments_view', request_id=r.id) }}"
                            class="btn btn-review" target="_blank">Comments</a>
                    
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No Perdiem requests submitted yet.</p>
        {% endif %}
    </div>

    <!-- AI Engine Overlay -->
    <div id="processingOverlay" style="display:none;">
        <div class="ai-container">
        <div class="ai-circle-wrapper">
            <div class="ai-circle"></div>
            <div class="ai-circle"></div>
            <div class="ai-circle"></div>
            <div class="ai-circle"></div>
        </div>
        <h3 class="ai-text">AI Engine Running Processing Receipts...</h3>
        </div>
    </div>


   


    <script>
                /* CLIENT SIDE VALIDATION */
        const MAX_3MB = 3 * 1024 * 1024;
        const MAX_5MB = 5 * 1024 * 1024;
        const IMG_TYPES = ['image/jpeg','image/png'];
        const PDF = 'application/pdf';

        
        function validateFiles(input, max, allowPdf, allowImg) {
        for (let f of input.files) {
            if (f.size > max) {
            alert(`${f.name} exceeds size limit`);
            input.value = '';
            return false;
            }
            if (
            (f.type === PDF && !allowPdf) ||
            (IMG_TYPES.includes(f.type) && !allowImg)
            ) {
            alert(`${f.name} invalid file type`);
            input.value = '';
            return false;
            }
        }
        return true;
        }

        document.querySelectorAll('input[type="file"]').forEach(i => {
        i.addEventListener('change', () => {
            if (i.name === 'form2_file') {
            validateFiles(i, MAX_5MB, true, false);
            } else {
            validateFiles(i, MAX_3MB, true, true);
            }
        });
        });

        /* UPLOAD PROGRESS */
    

        /* DELETE RECEIPT */
        
        function deleteReceipt(id, el) {
        fetch(`/receipt/${id}/delete`, {method:'POST'})
            .then(r=>r.json())
            .then(d=>{
            if(d.success) el.closest('.receipt-item').remove();
            });
        }

        document.getElementById('systemGeneratedCard').addEventListener('submit', function(e) {
            // Just before submit, copy again the hidden inputs to ensure latest values
            const step1 = document.getElementById('systemStep1');
            const form = e.target;
            const inputs = step1.querySelectorAll('input, select');

            inputs.forEach(input => {
                const hidden = form.querySelector(`input[type="hidden"][name="${input.name}"]`);
                if (hidden) hidden.value = input.value;
            });
        });



        document.getElementById('proceedBtn').addEventListener('click', function () {
        const form1 = document.getElementById('form1');

        if (!form1.checkValidity()) {
            form1.reportValidity();
            return;
        }

        const targets = document.querySelectorAll(
            '#selfUploadCard input[type="hidden"], #systemGeneratedCard input[type="hidden"]'
        );

        targets.forEach(input => {
            if (form1.elements[input.name]) {
                input.value = form1.elements[input.name].value;
            }
        });

        document.getElementById('form1Card').style.display = 'none';
        document.getElementById('form2Card').style.display = 'block';
        showForm2Option('self');
    });



      
    
        // Show Self / System form
        function formatBirr(input) {
            let value = input.value.replace(/,/g, '');

            // Allow only numbers and decimal
            if (!/^\d*\.?\d{0,2}$/.test(value)) {
                value = value.slice(0, -1);
            }

            if (value === "") {
                input.value = "";
                return;
            }

            let parts = value.split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            input.value = parts.join(".");
        }
        
        
        function showForm2Option(option) {
            const selfCard = document.getElementById('selfUploadCard');
            const sysCard = document.getElementById('systemGeneratedCard');

            if (option === 'self') {
                selfCard.style.display = 'block';
                sysCard.style.display = 'none';

                // Enable self upload inputs
                selfCard.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);

                // Disable system generated inputs
                sysCard.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);

                selfCard.querySelector('input[name="form2_file"]').required = true;
            } else {
                selfCard.style.display = 'none';
                sysCard.style.display = 'block';

                // Disable self upload inputs
                selfCard.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);

                // Enable system generated inputs
                sysCard.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);

                selfCard.querySelector('input[name="form2_file"]').required = false;
            }
        }
    
        // System Generated Step1 -> Step2
        function goToSystemStep2(event) {
            event.preventDefault();

            const step1 = document.getElementById('systemStep1');
            const step2 = document.getElementById('systemStep2');
            const form = document.getElementById('systemGeneratedCard');

            const inputs = step1.querySelectorAll('input, select');
            let valid = true;

            inputs.forEach(input => {
                if (!input.checkValidity()) valid = false;

                // copy value to hidden input
                const hidden = form.querySelector(`input[type="hidden"][name="${input.name}"]`);
                if (hidden) hidden.value = input.value;
            });

            if (!valid) {
                step1.reportValidity();
                return;
            }

            // disable visible inputs so they don't cause duplicates on submit
            inputs.forEach(input => {
                input.disabled = true;
            });

            step1.style.display = 'none';
            step2.style.display = 'block';
        }



    
        // === Notification on Submit (Option 1) ===
        function handleSubmitWithNotification(event, formType) {
            // event.preventDefault(); // Stop normal submission
            alert(formType + " form submitted successfully!");
            //event.target.submit(); // Now submit normally
        }
    
        // Attach notification to Self Upload form
        document.getElementById('selfUploadCard').addEventListener('submit', function(e){
            handleSubmitWithNotification(e, 'Self Upload');
        });
    
        // Attach notification to System Generated form
        document.getElementById('systemGeneratedCard').addEventListener('submit', function(e){
            handleSubmitWithNotification(e, 'System Generated');
        });
   // === Show processing overlay on submit ===
['selfUploadCard', 'systemGeneratedCard'].forEach(formId => {
    const form = document.getElementById(formId);
    form.addEventListener('submit', function(e){
        // Show overlay immediately
        const overlay = document.getElementById('processingOverlay');
        if (overlay) overlay.style.display = 'flex';

        // Optional: let the form submit normally
        // Remove previous alert() or polling
    });
});


const profileToggle = document.getElementById('profileToggle');
    const profileDropdown = document.getElementById('profileDropdown');
    const showChangePassword = document.getElementById('showChangePassword');
    const changePasswordForm = document.getElementById('changePasswordForm');

    // Toggle dropdown
    profileToggle.addEventListener('click', () => {
        profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
        // hide form when dropdown toggled off
        if(profileDropdown.style.display === 'none') changePasswordForm.style.display = 'none';
    });

    // Toggle Change Password form
    showChangePassword.addEventListener('click', () => {
        changePasswordForm.style.display = changePasswordForm.style.display === 'block' ? 'none' : 'block';
    });

    // Optional: hide dropdown if clicked outside
    document.addEventListener('click', (e) => {
        if (!profileDropdown.contains(e.target) && !profileToggle.contains(e.target)) {
            profileDropdown.style.display = 'none';
            changePasswordForm.style.display = 'none';
        }
    });



        
    </script>

</body>
</html>
